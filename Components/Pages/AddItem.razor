@page "/add-item"
@inject Services.ItemStateService ItemStateService
@inject NavigationManager nav
@inject Services.LoadingService LoadingService

<h3>Add New Item</h3>
<EditForm Model="newItem" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="name" class="form-label">Name</label>
        <InputText id="name" class="form-control" @bind-Value="newItem.Name" />
    </div>

    <div class="mb-3">
        <label for="category" class="form-label">Category</label>
        <InputText id="category" class="form-control" @bind-Value="newItem.Category" />
    </div>
    <div class="mb-3">
        <label for="timeWorn" class="form-label">Times Worn</label>
        <InputNumber id="timeWorn" class="form-control" @bind-Value="newItem.TimeWorn" />
    </div>
    <div class="mb-3">
        <label for="color" class="form-label">Color</label>
        <InputText id="color" class="form-control" @bind-Value="newItem.Color" />
    </div>

    <div class="mb-3">
        <label for="size" class="form-label">Size</label>
        <InputText id="size" class="form-control" @bind-Value="newItem.Size" />
    </div>

    <div class="mb-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select mb-2" @bind="status">
            @foreach(var s in ItemStateService.GetAllStatuses()){
                <option value="@s.Name">@s.Name</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Image</label>
        <InputFile OnChange="OnInputFileChange" accept="image/*" />
        <div class="mt-2">
            <label class="form-label">Or enter image URL</label>
            <InputText class="form-control" @bind-Value="newItem.ImagePath" />
        </div>
        @if (!string.IsNullOrEmpty(newItem.ImagePath))
        {
            <div class="mt-2">
                <img src="@newItem.ImagePath" alt="Preview" style="max-width:200px; max-height:200px; object-fit:contain;" />
            </div>
        }
    </div>
    <button type="submit" class="btn btn-primary">Add Item</button>
</EditForm>

@code {
    private Models.Item newItem = new Models.Item();
    private string status = string.Empty;

    private async Task HandleValidSubmit()
    {
        var itemStatus = ItemStateService.GetStatusByName(status);
        if (itemStatus == null)
        {
            // Handle the case where the status is not found
            return;
        }

        newItem.Status = itemStatus;
        LoadingService.Show();
        await Task.Run(() => ItemStateService.AddItem(newItem));
        LoadingService.Hide();

        newItem = new Models.Item(); // Reset the form
        nav.NavigateTo("/");
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null)
            return;
        using var ms = new System.IO.MemoryStream();
        await file.OpenReadStream(1024 * 1024 * 15).CopyToAsync(ms);
        var bytes = ms.ToArray();
        newItem.ImagePath = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";
        StateHasChanged();
    }
}