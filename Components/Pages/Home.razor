@page "/"
@inject Services.ItemStateService ItemStateService
@inject IJSRuntime js
@inject NavigationManager nav
@inject Services.LoadingService LoadingService


<h3>Welcome to MyCloset!</h3>



<h4>Items</h4>
<a class="btn btn-primary mb-3" href="/add-item">Add New Item</a>
@if (ItemStateService.Items.Count == 0)
{
    <p>No items found. Please add some items to your closet.</p>
}
else
{
    
    <MudTable Items="ItemStateService.Items"
          Dense="true"
          Hover="true"
          Bordered="true"
          Breakpoint="Breakpoint.None">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Times Worn</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Image</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd>
            <a href="@($"/item/{context.Id}")" class="table-a">@context.Name</a>
        </MudTd>

        <MudTd>
            <div class="d-flex align-items-center">
                <span class="me-2">@context.TimeWorn</span>
                <MudIconButton Icon="@Icons.Material.Filled.Add"
                               Size="Size.Small"
                               OnClick="@(async () => await IncreaseTimeWorn(context.Id))" />

            </div>
        </MudTd> 
        <MudTd>
            <MudSelect T="string"
                    Value="@context.Status?.Name"
                    ValueChanged="@(async (string val) => await OnStatusChanged(context.Id, val))"
                    Dense="true"
                    Variant="Variant.Text">
                @foreach (var s in ItemStateService.GetAllStatuses())
                {
                    <MudSelectItem T="string" Value="@s.Name">@s.Name</MudSelectItem>
                }
            </MudSelect>
        </MudTd>
        <MudTd>
            @if (!string.IsNullOrEmpty(context.ImagePath))
            {
                <img src="@context.ImagePath" style="max-width:60px;" />
            }
        </MudTd>

    @* TODO: Remove this action column & make status editable inline *@
        @* <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                           OnClick="@(() => NavigateToEdit(context.Id))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           OnClick="@(() => ConfirmDelete(context.Id))" />
        </MudTd> *@
    </RowTemplate>
</MudTable>
}

<style>
    .table-a{
        color: #006bb7;
        text-decoration: underline;
    }
    .mud-popover.mud-popover-open{
        width: 120px;
        max-width: 200px !important;
    }
    .mud-paper{
        background-color: white;

    }
</style>
@code {
    private async Task ConfirmDelete(Guid id)
    {
        var ok = await js.InvokeAsync<bool>("confirm", "Are you sure you want to delete this item?");
        if (ok)
        {
            LoadingService.Show();
            await Task.Run(() => ItemStateService.DeleteItem(id));
            LoadingService.Hide();
            StateHasChanged();
        }
    }

    private async Task IncreaseTimeWorn(Guid id)
    {
        LoadingService.Show();
        await Task.Yield();
        var item = ItemStateService.GetItemById(id);
        if (item != null)
        {
            item.TimeWorn++;
            await Task.Run(() => ItemStateService.UpdateItem(item));
        }
        LoadingService.Hide();
        StateHasChanged();
    }

    private async Task NavigateToItem(Guid id)
    {
        LoadingService.Show();
        await Task.Yield();
        nav.NavigateTo($"/item/{id}");
    }

    private async Task NavigateToEdit(Guid id)
    {
        LoadingService.Show();
        await Task.Yield();
        nav.NavigateTo($"/item/edit/{id}");
    }

    private async Task OnStatusChanged(Guid id, string newStatus)
    {
        if (string.IsNullOrWhiteSpace(newStatus))
            return;

        var item = ItemStateService.GetItemById(id);
        if (item?.Status?.Name == newStatus)
            return;

        LoadingService.Show();
        await Task.Yield();
        await Task.Run(() => ItemStateService.UpdateItemStatus(id, newStatus));
        LoadingService.Hide();
        StateHasChanged();
    }
}